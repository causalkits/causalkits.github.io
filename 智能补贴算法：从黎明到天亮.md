---


---

<h1 id="智能补贴算法：从黎明到天亮">智能补贴算法：从黎明到天亮</h1>
<p>作为一篇技术文章取这样一个标题略显文艺，固然是我文采斐然，也是想表达我对智能补贴算法从懵懂无知到一知半解的过程，某种程度上也是象征智能补贴算法从蛮荒时代逐渐进入石器时代。我是想把智能补贴算法写成一个系列，希望能够让大家认识到这个领域是一个非常有趣的方向，里面充斥着各种难题和巧思，然后欣然活水到我们团队开拓这个领域。那么作为该系列的第一篇，下面会简单捋一遍我们对智能补贴算法思考。</p>
<h3 id="一、既要又要的悖论">一、既要又要的悖论</h3>
<p>如果你手中的资本足够充足，商业规模比较小的时候，你可以很任性地发放补贴，规模效益的增加足以覆盖补贴成本。而当市场份额足够大，规模效益红利就会递减，补贴的边际效益也会递减，成本就变得不可忽视。当业务不得不开始考虑补贴成本的时候，就演化成一个既要增长又要省钱的问题。以滴滴的补贴为例，如果我们希望冒泡转化率最大，一定是给所有人免单，显然这是不现实的，所以我们还需要考虑补贴成本能不能支撑起商业逻辑。上面的思考其实就相当于切断了一条路：不能按照成熟的推荐或者广告领域的算法，最大化点击率或者最大化转化率来实现。一直以来推荐和广告算是研究比较充分的一类算法，并且有成熟落地方案，如果不能照猫画虎猛操作一番，就意味着我们需要开拓一个全新的算法谱系：增量预估算法。</p>
<p>首先来解释一下什么叫增量预估，简单地说就是预估投入一笔钱会带来多少增长。预估增量看起来也没什么神奇之处，为什么值得单独构建一个算法分支来研究这个问题呢？最本质的原因是我们根本不知道增量是多少，现在假设给某个乘客10元补贴，那他会带来多少增量呢？其实这个问题很难回答，可能是1元，也可能是100元增量，这更像是一个概率问题，就算你把这个乘客找来他自己也不一定说的清楚自己增长了多少的GMV。实际上现在大多数能够落地的算法都是有监督学习，例如推荐算法知道某一次历史曝光是否被点击，这个结果可以被收集到，明确的信号会让模型变得有目标，精度也更高。说到这里不得不补充说一下AI其实还只是一个婴儿，解决有监督问题离真正的AI还很远，一众高手也都在说非监督学习才是未来。因此进行增量预估时，不知道每位乘客到底能增加多少在监督学习算法看来就像个刺猬无从下手，这就是为什么要、开辟一个新的算法分支来解决这个问题。</p>
<p>先把增量预估这个难题的解法抛在一边，回到最开始的问题：是不是增量预估就可以解决既要增长又要节约成本的目标呢？假设我们通过增量预估知道了投入任何金额成本带来的增量，那是不是说我们可以找到一个组合，让总增量最大同时又能满足成本限制呢？如果简单抽象一下，这不就是一个背包问题嘛，最多是一个大的动态规划问题。看起来只要我们把增量预估出来，好像真的可以化解这个既要又要的悖论了。</p>
<p>前面我实际引入了补贴算法的基本思路：增量预估和动态规划的结合，其实也是智能补贴问题的两个核心，下面我会针对这两个问题进行详细的补充。</p>
<h3 id="二、莽荒时代与石器时代">二、莽荒时代与石器时代</h3>
<p>好了还是开始讲故事吧，故事的起源要从人类的好奇心开始，从上世纪50年代开始，很多科学家就开始研究如何利用数据来找到事物起因。最先好奇的一拨人来自于生物和医学领域，找到引起某个病变的原因应该是这个领域high点，所以你会看到大量搞生物和医学的同志们开始成为了统计学家。与此同时也有不少的统计学家构思出来一套理论：因果推断（<code>casual inference</code>）。在那个小数据的时代，所有的奇技淫巧都是针对某几个case，比如要耗尽心力才能找到的<code>Instrumental Variable</code>，方法论也很难说得上体系，所以这个时段我称为莽荒时代。虽然是莽荒时代，但也比“道生一，一生二，二生三，三生万物”更加具体一点，已经初露学科的萌芽。说实话我在学回归算法的时候，也一度认为每个变量的权重能够解释其对结果的重要性，而实际上这只能反映相关性，并不是因果关系。这个时期的统计学家也在针对这个问题研究的热火朝天，到了今天这个问题还依然悬而未决，重担可能要交给这些搞AI的同志们了。说到这里因果推断要做的事其实也很简单，就是在排除其他因素干扰情况下，衡量某个变量多大程度上影响最终结果，如果把这个变量设定为补贴额度，就把因果推断和增量预估联系在一起了。<br>
Judea Pearl在2000年出版了《Causality: Models, Reasoning and Inference》，这本书可算是因果推断进入石器时代的开山之作，因为在<code>Byesian Networks</code>和<code>Causal Inference</code>上的杰出贡献，Pearl获得了2011年的图灵奖，也算是学界对他学术贡献的肯定，这位老爷子最鲜明的观点是监督学习其实就是<code>curve fitting</code>，可见他对于现有机器学习鄙视态度。推荐大家读一下他写得几本<code>Casual Inference</code>方向的书，都算是这个领域的经典。在确立了因果推断之后，这个领域的研究也逐渐繁荣起来，之后关于<code>Causal Inference</code>方向的论文也如雨后春笋，但多数也是隔靴搔痒，不是很过瘾。应用现有的因果推断工具很难说清楚增长与营销之间的关系，假如我们用<code>Mediation Model</code>构建了一个diagram，这种<code>Nonparameter Model</code>完全依赖天赋和灵感，输出的结果千差万别。<code>Causal Inference</code>的野心其实很大，希望能够从真实的观察（<code>Observable Data</code>）数据中找到因果关系，这个问题的攻克很可能是成为迈向AI的第一步，可见其难度。其实还存在一种更加靠谱衡量某个因素对结果影响的方法：那就是AB测试，客观且准确，缺点就是要做实验，这也是<code>Causal Inference</code>想要努力避免的。如果随机实验对我们来说不是难事，是不是可以通过控制其他变量不变，只施加某个干预（Intervention），并观察它对结果的影响，这也算是因果推断难题的一种简化。其实在数学上，它还有一个更加简单的表达形式，一般我们称为CATE（<code>Conditional Average Treatment Effect</code>），具体的数学公式如下：</p>
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mi>τ</mi><mo>^</mo></mover><mo>=</mo><mi>E</mi><mo stretchy="false">(</mo><msub><mi>Y</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo><mo>−</mo><msub><mi>Y</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mn>0</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
\hat{\tau}=E(Y_i(1)-Y_i(0))
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.69444em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.22222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.05764em;">E</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">0</span><span class="mclose">))</span></span></span></span></span></span></p>
<p>这里面的<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>τ</mi><mo>^</mo></mover></mrow><annotation encoding="application/x-tex">\hat{\tau}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.69444em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.22222em;"><span class="mord">^</span></span></span></span></span></span></span></span></span></span></span>就是我在第一节说到的增量，1表示施加某个Treatment，0表示不施加。CATE预估也形成了一套自己的算法体系，可以看到从2005年之后文章层出不穷，并且还与深度学习产生了很好的化学反应。不知道你是否注意到这个公式其实是一个期望，说明它衡量的是一个群体的增量，而不是每个个体，这就引发了两个疑惑：第一个是每个人的TE（<code>Treatment Effect</code>）该怎么预估，第二个是同一人不可能既处于实验组又处于实验组。对于第一个问题，我们可以做一个简单的假设，如果某个人属于一个小群体，那么可以用这个小群体的增益来代表这个人群，当然这个小群体怎么定义也是个技术活，甚至在2006年之后独立发展出来<code>Uplift</code>算法分支专门解决CATE的预估，并且在工业界得到了应用。第二个问题也被称为反事实（<code>Counterfactuals</code>）：我们可以认为实验组与对照组独立同分布，假装实验组的某个用户也能在对照组找到一个同样的人，当然这里面其实还遗留了很多问题，我在后面还会提到。</p>
<p>这里我用莽荒时代和石器时代来形容这个领域的发展，想要表达的是它还处于婴儿期，很多算法和工具都还不够完善，问题抽象大致能够描述清晰，但是工具却如石斧一般粗糙。你可以想象我们这些穿着几片树叶的算法工程师拿着石斧在制作一套精美家具，滑稽却又充满理想。</p>
<h3 id="三、波诡云谲的负增长">三、波诡云谲的负增长</h3>
<p>智能补贴在滴滴的应用非常广泛，比如我们耳熟能详的智能呼返、打车金以及套餐。这一节我不想详述这些项目的落地方案，而是想探讨一下补贴实验中经常遇到的一个现象以及背后的原因。现象大概是这样的：针对某个城市的用户进行补贴，结果观测出来实验组虽然施加了1%的补贴，但结果却出现了-3%的增长。看到这个结果，第一反应是反常识，给用户折扣，结果却导致用户减少打车的频次。这样捉摸不定的结果会第一时间摧毁掉大家做AB测试的热情，不如我们就开始裸奔吧，反正也测不准。那么出现这样的负增长原因是什么呢？你需要思考的第一个问题是：是不是我的实验设计不太合理。为什么这么说呢？实际任何一个AB实验要想做得成功，一定要针对具体的场景做科学的设计，要不然得出的结果不仅没有任何参考价值，还容易否定一个靠谱的优化动作。<br>
首先我们需要意识到我们的实验最小样本量到底需要多少？这个问题在头条这样的推荐场景可能是不需要考虑，因为样本量大到可以识别很小的增益，并且信号非常稳定，这也是为什么推荐领域很少提最小样本量。但在滴滴样本量很多时候是不够的，比如我们要针对某个小城市，某个小场景进行实验，数据量往往是不够的，小数据量往往要求实际的增长超过5%才能被测出来，而现实只有1%的增长，测到一个负值就不难理解了。<br>
万一我们的数据量是足够的，最小样本量可以支撑测到0.5%的增长，是不是就不会出现负增长呢？其实还有可能的，很多情况下我们的实验是在线分组（并且很多情况下不得不在线分组，例如新用户注册），如果你保留两个分组什么都不做，很可能会出现对照组显著高于实验组，这就是AA测试无法通过。不要小瞧这个问题，这里面其实是有自己的数学原理，具体可以看一下《Semiparametric Difference-in-Differences Estimators》和<br>
《Improving the Sensitivity of Online Controlled Experiments by Utilizing Pre-Experiment Data》这两篇Paper。更多情况下我们根本等不到AA测试通过，论文里面也阐述了我们该如何在AA不平的情况下进行实验，并且获得有效的结论。其实说的直白一点就是把AA期间存在的差异直接减掉，具体的合理性可以看看论文里面的证明。<br>
解决了AA测试的问题，是不是可以高枕无忧了呢？实际上你还是有可能出现负增长，我曾经做过几次这样的实验，离线将某个城市的用户分成两拨，历史AA都是调平的状态，之后观察还是会出现-2%的结果，如果进一步把数据量提升10倍，差异还是有-0.2%的差异。你可能会觉得0.2%这么小的差异应该可以开始很多实验了吧，然而现实是很有可能会导致ROI低50%，在一个毛利微薄的领域产出这样的结论也是致命的。问题还不仅仅如此，很多时候差异并不是稳定的，会随着时间在一个范围内来回波动。到底是什么原因导致这样的现象呢？你有很大概率遇到了不可解释的系统性波动，这种波动可以随着样本量持续增加而不断减少，但是还有一种情况是样本量增加也解决不了的，我们称之为辛普森悖论，这个悖论大概的现象是：我们分别针对某个城市男性和女性乘客做了实验，两个实验结果都显示女性对补贴更加敏感，但是如果把数据混合起来计算却显示男性更加敏感。这种悖论发生的最根本原因是两组实验男女比例存在很大差异。现在我们假想一下我们的实验组和对照组是不是在每一维特征上都是具有相同的分布呢？答案是大概率上会存在很多微观的不均，这种微观的分布不均也是带来波动性的原因之一。这种现象在医疗领域尤其明显，例如我们在做一组瑞德西韦对于新冠病人的双盲实验，由于只有700-800个病人进行临床试验，在设计实验时忘记在是否有糖尿&amp;抽烟这个维度上做到比例一致，结果双盲实验显示疗效不大，而真实的情况是实验组里面有很多糖尿&amp;抽烟的病人。针对这个问题统计学家找到了一种非常巧妙的处理方式，称为PSM（<code>Propensity Score Matching</code>，具体可以参考《Moving towards best practice when using inverse probability of treatment weighting (IPTW) using the propensity score to estimate causal treatment effects in observational studies》、《Estimating the Causal Effects of Marketing Interventions Using Propensity Score Methodology》），PSM大致的思路是给实验组和对照组中每个样本加一个权重，这个权重可以通过训练一个二分类模型（每条样本的标签是：该条样本是否属于实验组）确定，该方法可以很巧妙地消除<code>Observable Data</code>里面存在的辛普森悖论，但是这也是个技术活，在观察数据有偏情况下会发挥奇效，但在滴滴多数的AB实验中收效甚微。</p>
<h3 id="五、面向abtest建模">五、面向ABTest建模</h3>
<p>鉴于我对于<code>Causal Inference</code>理解不够深刻，我实在对<code>SEM</code>和<code>Causal Digram</code>无法建立信心，所以我是崇尚用ABTest来简化增量预估问题。说得更加直白一点：我不太懂因果推断，并且<code>Intervention</code>和<code>Counterfactuals</code>那一套看起来也不太靠谱，所以我推荐大家先从CATE的预估开始选型你的补贴算法。私底下我更喜欢把这一套算法叫做面向ABTest的建模，我们的目标是预估每条样本的增量，但现实中我们只有对照组和实验组的总体差异，这其实是一种非典型监督问题，要说完全没有信号，也还有一个总体效果，要说有信号，其实你也不确定每条样本到底增加了多少。</p>
<h4 id="cate">5.1 CATE</h4>
<p>首先我们把CATE的公式再次誊写一遍：</p>
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mi>τ</mi><mo>^</mo></mover><mo>=</mo><mi>E</mi><mo stretchy="false">(</mo><msub><mi>Y</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo><mo>−</mo><msub><mi>Y</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mn>0</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
\hat{\tau}=E(Y_i(1)-Y_i(0))
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.69444em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.22222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.05764em;">E</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">0</span><span class="mclose">))</span></span></span></span></span></span></p>
<p>有没有发现这里面有两个函数<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Y_i(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span>和<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Y_i(0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">0</span><span class="mclose">)</span></span></span></span></span>，分别表达的是在施加Treatment和不施加Treatment情况下的表现。一种非常直觉的解法是构建两个模型，分别预测实验组和对照组的产出结果，顾名思义这个算法思路也叫做Two-Model，通过构建两个模型相减的方式可以直接求出在施加某个Treatment情况下的增量。说到这里这个问题不就解了吗，没有什么是一个监督模型解决不了的，如果不行那就构建两个。然而事实没有那么容易，这个模型也是我们比较早的方案，对乘客的订单进行预估，结果发现回归出来的值rmse非常大，跟随便拍一个策略的预测也差不了多少。更糟糕的是你手上有两个这样的模型。如果数据量足够，大概率上我们可以训练出一个无偏的模型（也就是对于某个全体的均值预估是比较准的，我们经常听到的3%的差异就是指的这个值）。但是如果你细看一下每个人的预估结果，方差大到你让你怀疑是不是入错行了，现在还要把两个模型的方差加到一起。总而言之这样预估出来的CATE你要相信它是需要非常大勇气的。<br>
我们仔细分析一下Two-Model精度为什么这么差，首先原理上两个模型方差就是相加的，这个是个致命伤；其次这两个子模型本质是一个回归模型，在很多特征不足或者随机性很大的情况下很难有好的精度。针对第一个问题，其实还是有办法解决的，我们可以借用multi-task的思路，将两个模型的底层参数共享起来，这样可以把方差缩减为一个模型，这个算法因此也被安上Single-Model这个名字。这个也是我们在司机任务上计算CATE主要模型，用一个模型预测不同Treatment下司机的实际表现。然而Single-Model还是无法绕开模型本身精度的问题，对于乘客或者司机的GMV预估难度是非常大的，最主要的原因是很多关键特征是无法收集到的：例如在司机端有交通环境和调度问题，而在乘客侧需求不完全与历史相关。假设补贴增长在10%以上时，CATE对于精度的要求可能会相应放松一点，这也是我们判断司机任务能够使用Single-Model的原因之一。</p>
<p>2017年初Soren R. etc.提出了一个新的预估思路，并且命名为<code>X-Leaner</code>，具体的细节大家可以参照一下《Meta-learners for Estimating Heterogeneous Treatment Effects using Machine Learning》，论文里面也发现它在并不是在所有数据集上都有最好的结果，但是对于对照组实验组样本悬殊较大的场景，X-Leaner能够得到比较好的结果。这个算法基本的思路是对实验组和对照组分别预测两个模型<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>μ</mi><mo>^</mo></mover><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\hat{\mu}_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.69444em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal">μ</span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.22222em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.19444em;"><span class=""></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>和<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>μ</mi><mo>^</mo></mover><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">\hat\mu_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.69444em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal">μ</span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.22222em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.19444em;"><span class=""></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，然后用实验组模型<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>μ</mi><mo>^</mo></mover><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\hat\mu_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.69444em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal">μ</span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.22222em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.19444em;"><span class=""></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>预测对照组得到<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>μ</mi><mo>^</mo></mover><mn>1</mn></msub><mo stretchy="false">(</mo><msubsup><mi>x</mi><mi>i</mi><mn>0</mn></msubsup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\hat\mu_1(x_i^0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1.07277em; vertical-align: -0.258664em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.69444em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal">μ</span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.22222em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.19444em;"><span class=""></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -2.44134em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.258664em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，用对照组模型<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>μ</mi><mo>^</mo></mover><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">\hat\mu_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.69444em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal">μ</span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.22222em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.19444em;"><span class=""></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>预测实验组得到<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>μ</mi><mo>^</mo></mover><mn>0</mn></msub><mo stretchy="false">(</mo><msubsup><mi>x</mi><mi>i</mi><mn>1</mn></msubsup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\hat\mu_0(x_i^1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1.07277em; vertical-align: -0.258664em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.69444em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal">μ</span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.22222em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.19444em;"><span class=""></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -2.44134em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.258664em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>。然后通过与实际的产出<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">Y_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>和<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">Y_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>相减得到CATE的目标label：</p>
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mover accent="true"><mi>D</mi><mo>~</mo></mover><mi>i</mi><mn>0</mn></msubsup><mo>=</mo><msub><mover accent="true"><mi>μ</mi><mo>^</mo></mover><mn>1</mn></msub><mo stretchy="false">(</mo><msubsup><mi>X</mi><mi>i</mi><mn>0</mn></msubsup><mo stretchy="false">)</mo><mo>−</mo><msubsup><mi>Y</mi><mi>i</mi><mn>0</mn></msubsup></mrow><annotation encoding="application/x-tex">
\tilde{D}_i^0=\hat\mu_1(X_i^0)-Y^0_i 
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1.16719em; vertical-align: -0.247em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.92019em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal" style="margin-right: 0.02778em;">D</span></span><span class="" style="top: -3.60233em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.19444em;"><span class="mord">~</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.864108em;"><span class="" style="top: -2.453em; margin-left: -0.02778em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1.11411em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.69444em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal">μ</span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.22222em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.19444em;"><span class=""></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.864108em;"><span class="" style="top: -2.453em; margin-left: -0.07847em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1.11111em; vertical-align: -0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.864108em;"><span class="" style="top: -2.453em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></p>
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mover accent="true"><mi>D</mi><mo>~</mo></mover><mi>i</mi><mn>1</mn></msubsup><mo>=</mo><msubsup><mi>Y</mi><mi>i</mi><mn>1</mn></msubsup><mo>−</mo><msub><mover accent="true"><mi>μ</mi><mo>^</mo></mover><mn>0</mn></msub><mo stretchy="false">(</mo><msubsup><mi>X</mi><mi>i</mi><mn>1</mn></msubsup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
\tilde{D}_i^1=Y^1_i-\hat\mu_0(X_i^1)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1.16719em; vertical-align: -0.247em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.92019em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal" style="margin-right: 0.02778em;">D</span></span><span class="" style="top: -3.60233em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.19444em;"><span class="mord">~</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.864108em;"><span class="" style="top: -2.453em; margin-left: -0.02778em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1.11111em; vertical-align: -0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.864108em;"><span class="" style="top: -2.453em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1.11411em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.69444em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal">μ</span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.22222em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.19444em;"><span class=""></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.864108em;"><span class="" style="top: -2.453em; margin-left: -0.07847em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></span></p>
<p>这样得到的两组数据又可以预估两个CATE模型<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>τ</mi><mo>^</mo></mover><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">\hat{\tau}_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.84444em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.69444em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.22222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.1132em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>和<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>τ</mi><mo>^</mo></mover><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\hat{\tau}_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.84444em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.69444em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.22222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.1132em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，至此我们一共有了4个模型了，但是这还不是最后的CATE，我们还需要做一个加权动作：</p>
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mi>τ</mi><mo>^</mo></mover><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mi>g</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><msub><mover accent="true"><mi>τ</mi><mo>^</mo></mover><mn>0</mn></msub><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>g</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><msub><mover accent="true"><mi>τ</mi><mo>^</mo></mover><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">
\hat{\tau} (x)=g(x)\hat{\tau}_0+(1-g(x))\hat{\tau}_1
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.69444em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.22222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.03588em;">g</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.69444em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.22222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.1132em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.03588em;">g</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.69444em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.22222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.1132em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></p>
<p>这里<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">g(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.03588em;">g</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>我们一般选<code>Propensity Score</code>，好了一共5个模型，按道理应该叫做Five-Model。估计作者也觉得这样很尴尬，就重新建了一个Learner祠堂，叫做X-Learner，并且顺便把Two-Model称为T-Leaner，Single-Model叫做S-Learner，事实上这个命名方式也被后来的文章接受了。<br>
2017年底的时候Xinkun Nie也响应号召给自己的CATE算法取名为<code>R-Learner</code>，感兴趣的同学可以看看《Quasi-Oracle Estimation of Heterogeneous Treatment Effects》，这个算法基于Robinson变换（一个简单的推导，因为我也懒得推导公式，所以你也可以不用理会）构造出来一个自己的优化函数：</p>
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>τ</mi><mo>∗</mo></msup><mo stretchy="false">(</mo><mi mathvariant="normal">.</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mo><mi>arg</mi><mo>⁡</mo><mi>max</mi><mo>⁡</mo></mo><mi>τ</mi></msub><mo stretchy="false">{</mo><mi>E</mi><mrow><mo fence="true">[</mo><msup><mrow><mo fence="true">(</mo><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><msub><mi>Y</mi><mi>i</mi></msub><mo>−</mo><msup><mi>m</mi><mo>∗</mo></msup><mo stretchy="false">(</mo><msub><mi>X</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo><mo>−</mo><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><msub><mi>W</mi><mi>i</mi></msub><mo>−</mo><msup><mi>e</mi><mo>∗</mo></msup><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo><mi>τ</mi><mo stretchy="false">(</mo><msub><mi>X</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow><mn>2</mn></msup><mo>+</mo><msub><mi mathvariant="normal">Λ</mi><mi>n</mi></msub><mo stretchy="false">(</mo><mi>τ</mi><mo stretchy="false">)</mo><mo fence="true">]</mo></mrow><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">
\tau^\ast (.)=\mathop{\arg\max}_\tau\{E\left [\left(\big (Y_i-m^\ast(X_i)\big)-\big(W_i-e^\ast(x)\big)\tau(X_i)\right )^2+\Lambda_n(\tau)\right ]\}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.738696em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">.</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1.80002em; vertical-align: -0.65002em;"></span><span class="mop"><span class="mop"><span class="mop">ar<span style="margin-right: 0.01389em;">g</span></span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mop">max</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.057252em;"><span class="" style="top: -2.45586em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1132em;">τ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.24414em;"><span class=""></span></span></span></span></span></span><span class="mopen">{</span><span class="mord mathnormal" style="margin-right: 0.05764em;">E</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size2">[</span></span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.738696em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.07847em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="delimsizing size1">)</span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.738696em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mord"><span class="delimsizing size1">)</span></span><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.07847em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size1">)</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.05401em;"><span class="" style="top: -3.3029em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord"><span class="mord">Λ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span><span class="mclose">)</span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size2">]</span></span></span><span class="mclose">}</span></span></span></span></span></span></p>
<p>这是一个复杂的函数，其中<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>τ</mi></mrow><annotation encoding="application/x-tex">\tau</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.43056em; vertical-align: 0em;"></span><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span></span></span></span></span>就是我们想要求解的CATE预估函数或者模型，<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="normal">Λ</mi><mi>n</mi></msub><mo stretchy="false">(</mo><mi>τ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Lambda_n(\tau)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord">Λ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span><span class="mclose">)</span></span></span></span></span>是一个关于CATE预估模型的正则项，<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mo>∗</mo></msup><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">e^\ast(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.688696em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>是前面提到的<code>propensity score</code>，<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>i</mi></msub><mo>∈</mo><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">W_i\in(0,1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span>表示样本是否属于实验组，<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>m</mi><mo>∗</mo></msup><mo stretchy="false">(</mo><msub><mi>X</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">m^\ast(X_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.688696em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.07847em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>稍微难理解有点，我们首先来看一下公式：</p>
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>m</mi><mo>∗</mo></msup><mo stretchy="false">(</mo><msub><mi>X</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mi>E</mi><mo stretchy="false">(</mo><msub><mi>Y</mi><mi>i</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>X</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>=</mo><msup><mi>μ</mi><mo>∗</mo></msup><mo stretchy="false">(</mo><msub><mi>X</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>+</mo><msup><mi>e</mi><mo>∗</mo></msup><mo stretchy="false">(</mo><msub><mi>X</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>∗</mo><msup><mi>τ</mi><mo>∗</mo></msup><mo stretchy="false">(</mo><msub><mi>X</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
m^\ast(X_i)=E(Y_i|X_i)=\mu^\ast(X_i)+e^\ast(X_i)*\tau^\ast(X_i)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.738696em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.07847em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.05764em;">E</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.07847em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal">μ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.738696em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.07847em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.738696em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.07847em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.738696em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.07847em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></span></p>
<p>其实就是预估样本的实际结果期望的函数。<br>
R-Learner的目标函数整体来说起就是一个误差最小化，但是它有一个天大的好处，那就是无论你Deep大神还是机器学习大佬，你都可以利用这个神奇的损失函数来训练你的CATE模型，甚至你可以把<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>m</mi><mo>∗</mo></msup></mrow><annotation encoding="application/x-tex">m^\ast</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.688696em; vertical-align: 0em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.688696em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span></span>、<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mo>∗</mo></msup></mrow><annotation encoding="application/x-tex">e^\ast</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.688696em; vertical-align: 0em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.688696em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span></span>以及<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>τ</mi><mo>∗</mo></msup></mrow><annotation encoding="application/x-tex">\tau^\ast</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.688696em; vertical-align: 0em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.688696em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span></span>放到一起训练，反正不就是梯度下降嘛，当然论文里面把<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>m</mi><mo>∗</mo></msup></mrow><annotation encoding="application/x-tex">m^\ast</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.688696em; vertical-align: 0em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.688696em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span></span>和<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mo>∗</mo></msup></mrow><annotation encoding="application/x-tex">e^\ast</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.688696em; vertical-align: 0em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.688696em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span></span>当做先验知识来理解。我个人觉得这个算法还算是有前途的，但是最大的隐患依然来自于<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>m</mi><mo>∗</mo></msup><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">m^\ast(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.688696em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>模型的精度，所以这里还是号召大家把这个核心问题解决了。</p>
<p>2019年Uber基于自己的理解也给出了修改版的<code>X-Learner</code>和<code>R-Leaner</code>，《Uplift Modeling for Multiple Treatments with Cost Optimization》这篇论文可以说非常契合滴滴的应用，把补贴的费用考虑到了，并且还扩充成渠道和补贴成本，完全一样的业务，并且把重点放到了多Treatment上，这个跟我们团队的优化和修改非常一致。这篇文章算不上创新很多，但是应用上做得还是蛮精彩的，另外把最终的目标函数改写成<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mi>G</mi><mi>M</mi><mi>V</mi><mo>−</mo><mi mathvariant="normal">Δ</mi><mi>C</mi><mi>o</mi><mi>s</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">\Delta GMV-\Delta Cost</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.76666em; vertical-align: -0.08333em;"></span><span class="mord">Δ</span><span class="mord mathnormal" style="margin-right: 0.10903em;">GM</span><span class="mord mathnormal" style="margin-right: 0.22222em;">V</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord">Δ</span><span class="mord mathnormal" style="margin-right: 0.07153em;">C</span><span class="mord mathnormal">os</span><span class="mord mathnormal">t</span></span></span></span></span>给我们的启示蛮大的。它的另外一个贡献是给出了如果在多action下计算auuc以及如何在没有对照组情况下评估结果的好坏。</p>
<p>除去这些N-Model流派以外，我们也意识到Tree-Model可能更适合低补贴低增长的场景，也就是我们的C补应用，这波人显然跟Learner这帮人不是一个调调，文章也都比较早期，形式更加传统机器，并且也修了一个祠堂叫做<code>uplift</code>，其实供奉都是同一个祖先。无论是<code>Random Forest</code>或者<code>Decision Tree</code>构建起来的<code>uplift</code>模型可以直接输出CATE，并且这些增长的预估是基于某个sub-group给出的，这样就跟我们的C补应用很契合，毕竟我们也只是很少的用户才会带来增长，大部分人短期内不会因为小额补贴带来增长的。这个方向上的文章也不少，核心的优化点都在如何构建更好的<code>Impurity</code>以及<code>Gain</code>来找到最有利于CATE预估精度树的生长方式。如果大家感兴趣可以看一看《Decision trees for uplift modeling with single and multiple treatments》《Uplift Modeling with Multiple Treatments and General Response Types》。实践中我们也发现对于这种增长只发生某个子人群上，并且增长不是很多（比如1%GMV增长），Tree-Based uplift算法的效果精度更高。我们基于spark的Random Forest自己写了一个分布式实现，近期也在筹备在公司内部开源出来，如果有人感兴趣可以当一下我们的小白鼠。</p>
<h4 id="最优化">5.3 最优化</h4>
<p>写了上面这么多，CATE的问题我们大概找到了一些办法解决，可是如果仅仅预估出来多种补贴下的增长是不够的，不知道你是否有记得在第二节我提到这里面还有个背包问题，这个背包问题是用来在有限的预算下求出每个用户最优的补贴。但是现实中这样的背包问题不好解，我们都知道动态规划要有一个状态记录表，如果你的问题足够大，比如你有3亿用户每个人有10种券选择，这样的动态规划要消耗大量的内存，而且动态规划的计算复杂度也是很高，速度上很难保证。第二个问题是即使动态规划能够解出来，如果我增加一种限制怎么办？例如像司机任务里面要求头部司机不能发低单量，某个任务完成率不能太底等等。要想解决这两个难题，一个很自然的思考在于，要不用最优化来解一下这个问题吧。如果你仔细看看最优化这帮搞运筹学的同志们，你会发现他们研究的思路跟搞深度学习的有多么不同，他们对于所谓的大数据完全没准备好，最多能够支持的参数量级大概也就几百万。我们是个小团队，并且每个人都是搞机器学习的底子，所以我们就是否实现一个自己的大规模最优化算法决策时毅然选择放弃。于是我们就把业内最成熟的最优化工具拿过来用了，发现也刚刚够用，推荐大家也可以去尝试一下<code>google or-tools</code>。这个工具其实也是一个皮壳，比如在MILP这一块它使用的是CBC，线性规划用的是GLOP，这里我就不想做一个杠精比较各种优化工具了，如果够用你也就跟我一样偷着乐吧，如果不行那么恭喜你可以开始一段愉快的造轮子旅行了，说实话造轮子还挺开心的。对于补贴场景我们没有趟线性规划，直接用了整数规划（MILP），原因就是我们不太相信CATE是个线性函数。<br>
如果找到了或者打造了or-tools这样的工具，是不是一切就完事大吉了呢？其实还真没有这么简单，如果你把CATE预估出来直接丢到最优化中，你会惊奇的发现，最优化给你的结果有很多反常识的发放，比如给一个头部司机很低的门槛。经过我们仔细而缜密的占卜，结果发现CATE只要出现一个不准的预测，整个MILP会走向你无法控制的方向。那么CATE为什么预估不准呢？这个问题我就不想认真回答了，答案是怎么会有准的时候，并且有的结果会出现极大的偏差，这种有偏性会让最优化欣喜地以为某些异常点是个史上最优的选择。所以我们的经验是要把CATE模型调的准一点，如果你实在调不准至少要做到是无偏估计，如果做不到无偏，最好你能多做一些数据Explore把数据搞多点，如果还是解决不了，那就丢掉那些不准的预测结果吧。</p>
<h4 id="强化学习">5.3 强化学习</h4>
<p>前面介绍了CATE+最优化的组合拍档，这里再介绍一种写文章更加酷炫的思路，那就是强化学习。我们知道强化学习有一个优良的品质，那就是世界上多数人构造的模型都是不收敛的，它可以凭借这个优良的玄学特性唬住很多人。那为什么智能补贴可以很自然地想到强化学习呢？原因也很简单，强化学习强调的是长期收益最大，补贴恰好也要关注LTV，另外CATE不是很难预估嘛，我们要不就直接来最大化最后的收益吧，这样是不是显得更加端到端。所以真的就有同学开始行动了，感兴趣的同学可以看看阿里的这篇《A Policy Gradient Method with Variance Reduction for Uplift Modeling》，里面构造了一个自己的Reward，对于state的构造我觉得我这辈子也想不到，实验的结果感觉也不是很有说服力，我没有深究这个模型是不是有可行性，因为我也不打算实现一个。另外咱们滴滴的同学也写了一篇《Environment Reconstruction with Hidden Confounders for Reinforcement Learning based Recommendation》，用强化学习的思路来做Environment的重构，是不是有效我们也找了Qingyang Li在做验证，如果有好的效果我会回来更新一下。</p>
<p>我自己对于强化学习的偏见可能会让我对它很谨慎，但是它在智能补贴上的应用我还是持乐观判断的。这里说几点我觉得可以突破的地方，首先Experience Replay跟uplift是有结合点的，最大化收益可以绕过CATE的预估，用DNN来训练最优化选择器可能比直接用最优化更加promising。好啦，各位吃瓜群众可以期待一下我们团队这方面的paper。</p>
<h3 id="六、补贴是个系统工程">六、补贴是个系统工程</h3>
<p>上面介绍了智能补贴的基础算法，好像智能补贴已经手到擒来了，毕竟算法都已经给出来了。然而我想说的是智能补贴是个系统工程，很难一蹴而就。为什么这么说呢？首先在很多场景下，补贴要给出准确的判断依赖科学严谨的实验，而这个实验的设计不仅要依赖补贴架构，也会要求我们形成系统的小流量实验规范。比如我们需要做一个自动化的AA调平工具，需要一套小流量评估体系，需要有一个灰度上线机制，需要一套有效的Explore&amp;Exploit方法，可能还需要写一套最优化和CATE工具集。为了支持业务，需要一个灵活的业务服务框架，需要一个自动化的报表系统，需要一个日志收集系统，甚至需要一个体验策略库。除了这些基础的组件外，如果我们还想往智能补贴方向前进更多，我们还需要一个对于城市B端和C端准确的诊断系统，需要圈出哪些乘客有弹性，哪些区域需要补贴，哪些司机有可能流失。基于这些诊断信息，我们应该如何分配我们的预算能够让长期生态和短期收益取得平衡。<br>
所以说智能补贴是个系统工程并不是为了夸大他的复杂性，而是为了强调要想实现一个实用的补贴系统，算法只是其中很小的一部分，在算法之外有很多环节也能够决定成败。</p>
<h3 id="七、总结">七、总结</h3>
<p>作为一个技术性的文章，按道理不应该有一个煽情的总结。我这里还是强调一下我写这篇文章的目标：吸引更多的算法同学关注这个领域，理解这个方向，并且相信它是商业环节里面重要的工具。并且在面对一个比推荐和广告还要难的算法问题时，我们并不是一无所有，至少我们已经度过荒莽时代，走到了石器时代，而接下来的青铜时代有待我们去开拓。</p>

